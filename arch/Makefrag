OBJDIRS += arch

ARCH_SRCFILES := $(wildcard arch/*.rs) \
	$(wildcard arch/cpu/*.rs) \
	$(wildcard arch/drivers/*.rs)

$(OBJDIR)/arch/morestack.o: arch/morestack.S
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -nostdinc -c -o $@ $<

$(OBJDIR)/arch/$(LIB_MORESTACK): $(OBJDIR)/arch/morestack.o
	$(AR) crus $@ $<

$(OBJDIR)/arch/$(RLIB_ARCH): $(ARCH_SRCFILES) $(OBJDIR)/arch/$(LIB_MORESTACK)
	@mkdir -p $(@D)
	$(RUSTC) $(RUSTFLAGS) --ar $(AR) --out-dir $(@D) arch/mod.rs

all: $(OBJDIR)/arch/$(RLIB_ARCH)
