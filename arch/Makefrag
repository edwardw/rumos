OBJDIRS += arch

ARCH_SRCFILES := $(wildcard arch/*.rs) \
	$(wildcard arch/cpu/*.rs) \
	$(wildcard arch/drivers/*.rs)
ARCH_DEPS := $(OBJDIR)/arch/$(LIB_MORESTACK) \
	$(OBJDIR)/rust-core/$(RLIB_CORE) \
	$(OBJDIR)/rust-std/$(RLIB_STD)

$(OBJDIR)/arch/morestack.o: arch/morestack.S
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -nostdinc -c -o $@ $<

$(OBJDIR)/arch/$(LIB_MORESTACK): $(OBJDIR)/arch/morestack.o
	$(AR) crus $@ $<

$(OBJDIR)/arch/$(RLIB_ARCH): $(ARCH_SRCFILES) $(ARCH_DEPS)
	@mkdir -p $(@D)
	$(RUSTC) $(RUSTFLAGS) --ar $(AR) --out-dir $(@D) arch/mod.rs

all: $(OBJDIR)/arch/$(RLIB_ARCH)
